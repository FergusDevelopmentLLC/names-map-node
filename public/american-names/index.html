<!DOCTYPE html>
<html lang="en">
<head>
	<title>American Names of the Last Century (1910-2016)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0">

		<link href="http://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Arimo" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Droid+Sans+Mono" rel="stylesheet">
    <link rel="stylesheet" href="css/awesomplete.css" />

		<!--<link rel="stylesheet" href="css/tingle.min.css" media="all">-->
		<link rel="stylesheet" href="css/bulma.css">
		<link rel="stylesheet" href="../../font-awesome/css/font-awesome.min.css">
		<link rel="stylesheet" href="css/fontello.css">
		<link rel="stylesheet" href="css/custom.css">

    <script src="js/utils.js"></script>
    <script src="js/awesomplete.js"></script>
    <script src="js/colorbrewer.js"></script>
    <script src="js/cartocolor.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <script src="https://momentjs.com/downloads/moment.min.js"></script>
    <script src="https://unpkg.com/simple-statistics@4.1.0/dist/simple-statistics.min.js"></script>
    <script src="http://spin.js.org/spin.min.js"></script>
    <script src="js/spin_opt.js"></script>
    <!-- <script src="js/tingle.min.js"></script> -->

		<style>

		</style>
</head>

<body class="theme-page">

  <section class="hero is-primary">
    <div class="hero-head">
      <nav class="navbar main-nav">
        <div class="container">
          <div class="navbar-brand">
            <div class="navbar-item">American Names of the Last Century (1910-2016)</div>
            <span class="navbar-burger burger" data-target="navbarMenuHeroA">
              <span></span>
              <span></span>
              <span></span>
            </span>
          </div>
          <div id="navbarMenuHeroA" class="navbar-menu">
            <a class="navbar-end navbar-item about-link about-link-header">About this Map</a>
          </div>
        </div>
      </nav>
    </div>
  </section>

  <section class="section" id="main">
    <div class="container">
      <div class="columns">
        <div class="column is-4 legend-column legend">
					<div class="columns is-multiline">
						<div class="column is-12 name-search-column">
							<i class="fa fa-search fa-1x" id='search-icon' aria-hidden="true"></i>
							<span id='search-widget-wrapper'>
								<input type='text' id='name-input' class='name-input'>
							</span>
							<i class="fa fa-random fa-1x" id='random-icon' aria-hidden="true"></i>
						</div>
						<div class="column is-12 boygirl-switch-column">
							<div class="field has-addons boygirl">
								<p class="control">
									<a class="button" id="button-boy">
										<span>Boy</span>
									</a>
								</p>
								<p class="control">
									<a class="button" id="button-girl">
										<span>Girl</span>
									</a>
								</p>
							</div>
							<input type="hidden" id="gender" name="gender" value="M" />
						</div>
						<div class="column is-12 year-column">
							<span id='year-flame-wrapper'><i class="icon-fire"> </i><span id='year-wrapper'></span> <i class="icon-fire"></i></span>
						</div>
						<div class="column is-12 births-column">
							<span id='births-wrapper'></span>
						</div>
						<div class='column is-12 since-column'>
							<span id='since-wrapper'></span>
						</div>
						<div class="column is-12 bar-chart-column">
							<div id='bar-chart-wrapper'></div>
						</div>
						<div class="column is-12 cells-column">
							<div id='cells-wrapper'></div>
						</div>
						<div class="column is-12 slider-column">
							<div id='slider-wrapper'>
								<input type='range' id='slider-year' class='slider-year' />
							</div>
						</div>
						<div class="column is-12 slider-label-column">
							<div id='min-year-label' class='year-label'>1910</div>
							<div id='max-year-label' class='year-label'>2016</div>
						</div>
						<div class="column is-12">
							<div id='about-legend-wrapper'>
								Data Source: <a href='https://www.ssa.gov/oact/babynames/limits.html' target='_blank'>U.S. Social Security Administration</a><br/>
							</div>
						</div>
					</div>
				</div>
        <div class='column is-8' id='map-column'>
					<div class="columns is-multiline">
						<div class="column is-12">
							<div id='map-wrapper'></div>
						</div>
				</div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <div class="content has-text-centered footer-content">
        <p>
					&copy; Copyright <span id='copyright-year'></span> <a href='https://fergusdevelopmentllc.github.io/'>Fergus Development LLC</a>
				</p>
      </div>
    </div>
  </footer>

	<div class="modal">
	  <div class="modal-background"></div>
	  <div class="modal-content">
			<h1>American Names of the Last Century (1910-2016)</h1>
	    <p>This map was created as a final project for <a href='http://newmapsplus.uky.edu/new-maps-plus-programs-and-online-courses'>MAP 673 â€“ Design for Interactive Web Mapping</a> in the <a href='http://newmapsplus.uky.edu/' target='blank'>The New Maps Plus</a> Masters Program and the University of Kentucky. Much thanks to <a href='https://twitter.com/rgdonohue' target='blank'>@rgdonohue</a> for many helpful pointers on this project and others. This project was built with ...</p>
			<ul>
				<li><a href='http://newmapsplus.uky.edu/' target='_blank'><img src='images/NMP_120x50.png' id='about-nmp' /></a></li>
				<li><a href='https://d3js.org/'><img src='images/d3_40x38.png' /></a></li>
				<li><a href='http://postgis.net/'><img src='images/postgis_66x38.png' /></a></li>
				<li><a href="https://nodejs.org"><img src='images/nodejs_62x38.png' /></a></li>
				<li><a href="https://www.python.org/"><img src='images/python_150x38.png' /></a></li>
				<li><a href="https://www.w3.org/Graphics/SVG/"><img src='images/svg_97x38.png' /></a></li>
				<li><a href="https://github.com/topojson/topojson"><img src='images/topojson_79x38.png' /></a></li>
				<li><a href="https://bulma.io/"><img src='images/bulma_82x38.png' /></a></li>
				<li><a href="http://sass-lang.com/"><img src='images/sass_33x38.png' /></a></li>
			</ul>
			<h2>Check out these interesting names/years</h2>
			<div class="columns is-multiline about-examples">
				<div class="column is-4">
					<div class='headshot'>
			      <span class='effect fdr'></span>
			      FDR effect? <a href='/names/d3/?name=Roosevelt&sex=M'>Roosevelt</a> (1933)
			    </div>
				</div>
				<div class="column is-4">
					<div class='headshot'>
			      <span class='effect elvis'></span>
			      <a href='/names/d3/?name=Elvis&sex=M'>Elvis</a> Presley effect?</a> (1957)
			    </div>
				</div>
				<div class="column is-4">
					<div class='headshot'>
			      <span class='effect jfk'></span>
			      JFK effect? <a href='/names/d3/?name=Kennedy&sex=M'>Kennedy</a> (1964)
			    </div>
				</div>
				<div class="column is-4">
					<div class='headshot'>
			      <span class='effect streisand'></span>
			      <a href='/names/d3/?name=Barbra&sex=F'>Barbra</a> Streisand effect? (1966)
			    </div>
				</div>
				<div class="column is-4">
					<div class='headshot'>
			      <span class='effect keifer'></span>
			      <a href='/names/d3/?name=Keifer&sex=M'>Keifer</a> Sutherland effect? (1991)
			    </div>
				</div>
				<div class="column is-4">
					<div class='headshot'>
			      <span class='effect channing'></span>
			      <a href='/names/d3/?name=Channing&sex=M'>Channing</a> Tatum effect? (2012)
			    </div>
				</div>
				<div class="column is-12">
					<div class='headshot'>
			      <span class='effect luke_leia'></span>
			      Star Wars effect (spikes in 1980)? [<a href='/names/d3/?name=Luke&sex=M&yr=1980'>Luke</a>, <a href='/names/d3/?name=Leia&sex=F&yr=1980'>Leia</a>]
			    </div>
				</div>
			</div>
			<h2>Thanks!</h2>
			<p>...For spending a bit of time here. Check out the <a href='https://github.com/FergusDevelopmentLLC/names-map-node'>GitHub repo</a> and <a href='https://fergusdevelopmentllc.github.io/'>my portfolio</a> for a deeper look. Have a question, suggestion or find an interesting name? <a href='https://twitter.com/zippyFerguson' target='_blank'>Let me know</a>! For a similar project on the most popular U.S. Boys/Girls Names (1910-2016), check out the following <a href='http://104.236.16.91:8650/top-names-map/' target='_blank'>map</a>.</p>
			<div id='about-map-img-wrapper'>
				<a href='http://104.236.16.91:8650/top-names-map/' target='_blank'><img src='images/top_names.png' /></a>
			</div>
	    <p id='about-sig'>-<a href='https://fergusdevelopmentllc.github.io/'>Will Carter</a></p>
			<button class="modal-close is-large" aria-label="close"></button>
	  </div>
	</div>

	<script>

	var default_popular_name = 'Quinn',
			default_sex = 'M',
			sex = 'M',
			prev_sex = 'M',
			number_of_breaks = 5,
			this_year = 1910,
			min_year = 1910,
			max_year = 2016,
			most_popular_year = this_year,
			breaks = [],
			occurrences = '',
			total_occurrences_all_time = 0,
			total_occurrences_for_year = 0,
			color_key = 'cartocolor.Mint' //https://github.com/CartoDB/CartoColor/wiki/CARTOColor-Scheme-Names or colorbrewer.Greens http://127.0.0.1:8645/names/d3/?ck=colorbrewer.Greens
			novalue_color = '#ffffff',
			tooltip = '',
			name_list = '',
			slider = '',
			handle = '',
			spin_target = document.getElementById('main'),
			spinner = '',
			mode = 'display',
			bar_fill_color = '#ffffff',
			highlight_color = '#e6550d',
			default_gray = '#696969';

	handleBoyGirlClick();

	color_key = getColorKeyFromQS();

	highlight_color = getHighlightColorFromQS();

	var geoPath = d3.geoPath()
		.projection(d3.geoAlbersUsa()
			.scale(800));

	tooltip = d3.select("body").append("div")
		.attr("class", "tooltip")
		.style("opacity", 0);

	popular_name = getNameFromQS();

	sex = getSexFromQS();

	d3.select('#gender').attr('value', sex);

	d3.select('#copyright-year').html((new Date()).getFullYear());

	d3.selectAll('.icon-fire').style('color', highlight_color);

	d3.select('#search-icon').on('mouseover', function() {
		this.style.color = highlight_color;
	}).on('mouseout', function() {
		this.style.color = '#4a4a4a';
	});

	d3.select('#random-icon').on('mouseover', function() {
		this.style.color = highlight_color;
		}).on('mouseout', function() {
			this.style.color = '#4a4a4a';
		});

	d3.select('#search-icon').on('click', function() {
		document.getElementById('name-input').focus();
	});

	d3.select('#random-icon').on('click', function() {
		randomStart();
	});

	d3.selectAll('.about-link').on('click', function() {
		d3.selectAll('.modal').classed('is-active', true);
	});

	d3.selectAll('.modal-close').on('click', function() {
		d3.selectAll('.modal').classed('is-active', false);
	});

	if(popular_name == default_popular_name && sex == default_sex) {
		randomStart(); //get a random name, if none passed.
	}
	else {
		init();
	}

	function randomStart() {
		d3.queue()
			.defer(d3.json, "/popular_name/getRandomName")
			.await(setName);
	}

	function setName(error, random_name_data) {

		sex = random_name_data[0].sex;

		d3.select('#gender').attr('value', sex);

		popular_name = random_name_data[0].name;

		init();
	}

	function init() {

		spinner = new Spinner(opts).spin(spin_target);

		d3.select('.year-column').style('display', 'none');
		d3.select('.births-column').style('display', 'none');
		d3.select('.since-column').style('display', 'none');
		d3.select('.bar-chart-column').style('display', 'none');
		d3.select('.cells-column').style('display', 'none');
		d3.select('.slider-column').style('display', 'none');
		d3.select('.slider-label-column').style('display', 'none');

		setMaleFemaleSwitch();

		addMapContainer();

		addBackgroundToMapContainer();

		//set sex to match gender value
		sex = d3.select('#gender').attr('value');

		//force name to be camel case
		popular_name = toCamelCase(popular_name);

		//this will repopulate the name lookup input with only the sex selected on the Boy/Girl switch
		handleAutocomplete('display');

		data_url = '/popular_name/getNameData/' + popular_name + '/' + sex;

		console.log(data_url);

		d3.queue()
			.defer(d3.json, 'data/states.topojson')
			.defer(d3.json, data_url)
			.await(makeMap);

	}

	function makeMap(error, statestopo, name_data) {

		if(error || parseInt(name_data.length) == 0) {

			spinner.stop();
			d3.select('#spinner-wrapper').style('display','none');
			// d3.select('#search-widget-wrapper').style('display','block');
			d3.select('#button-boy').style('display','block');
			d3.select('#button-girl').style('display','block');

			//setting a delay here, intermittently wouldn't work. autocomplete?
			setTimeout(function(){
				var name_input = document.getElementById('name-input');
				name_input.value = '* No Data *';
			}, 100);

			return;
		}

		populateOccurencesFrom(name_data);

		joinDataToGeom(statestopo, name_data);

		addStatesToMapContainer(statestopo);

		populateMaxMinYear();

		setMostPopularYear();

		this_year = getYearFromQS();

		populateBreaks(number_of_breaks, statestopo);

		setBarFillColor();

		addYearFlameTooltip();

		addBars();

		highlightBarForThisYear();

		addCells();

		addSlider();

		spinner.stop();

		d3.select('.year-column').style('display', 'block');
		d3.select('.births-column').style('display', 'block');
		d3.select('.since-column').style('display', 'block');
		d3.select('.bar-chart-column').style('display', 'block');
		d3.select('.cells-column').style('display', 'block');
		d3.select('.slider-column').style('display', 'block');
		d3.select('.slider-label-column').style('display', 'block');

		tooltip.style('opacity', 0);//TODO, figure a better tooltip

		updateMap();

	};

	function updateMap() {

		total_occurrences_for_year = 0;
		total_occurrences_all_time = 0;

		var states_svg = d3.select('#states_svg_map');

		states_svg.selectAll(".state")
		  .style('fill', function(d) {
		    var fill = novalue_color;
		    //console.log(d);
		    if (d.properties.occurrences.length > 0) {
		      for (var occurrence in d.properties.occurrences) {
		        var occurrence_date = new Date(d.properties.occurrences[occurrence].date);
		        if(occurrence_date.getFullYear() == this_year && d.properties.occurrences[occurrence].oc > 0) {
		          total_occurrences_for_year += d.properties.occurrences[occurrence].oc;
		          var this_fill = getColor(d.properties.occurrences[occurrence].normalized, breaks);
		          fill = this_fill;
		        }
		        if(occurrence_date.getFullYear() <= this_year) {
		          total_occurrences_all_time += d.properties.occurrences[occurrence].oc;
		        }
		      }

		      //show the flames if this is the most_popular_year
		      if(this_year == most_popular_year) {
		        d3.selectAll('.icon-fire').style('opacity', 1);
		      }
		      else {
		        d3.selectAll('.icon-fire').style('opacity', 0);
		      }

		      var births_text = total_occurrences_for_year.toLocaleString() + " births ";
		      d3.select('#births-wrapper').html(births_text);

		    }
		    var since_txt = total_occurrences_all_time.toLocaleString() + " since " + min_year;
		    d3.select('#since-wrapper').text(since_txt);
		    return fill;
		  });

	}

	function handleAutocomplete() {
		d3.queue()
			.defer(d3.json, 'data/names_by_popularity.json')
			.await(addAutoCompleteInput);
	}

	function addAutoCompleteInput(error, most_pop_names) {

		//filter based on current sex
		name_list = most_pop_names.map(function(x) {
			if(x.sex == sex)
				return x.name + "&nbsp;(" + getDisplayGender() + ")";
		});

		d3.select('#name-input').remove();
		//add it back
		d3.select('#search-widget-wrapper').append('input')
			.attr('id', 'name-input')
			.attr('class', 'name-input');

		var placeholder_text = "Search for " + getDisplayGender().toLowerCase() + "s name";

		name_input = document.getElementById('name-input');
		name_input.value = popular_name;
		name_input.placeholder = placeholder_text;

		var autocomplete = new Awesomplete(name_input, {
			list: name_list
		});

		Awesomplete.$.bind(name_input, { "awesomplete-selectcomplete": nameSelected });

		d3.select("#name-input").on("focus", function() {
				this.value = '';
				d3.select(this).attr('class', 'name-input-edit');
			});

		d3.select("#name-input").on("blur", function() {
				d3.select(this).attr('class', 'name-input');
				var entered_value = this.value.replace(/\s/g,'');
				if(entered_value == '') {
					this.value = popular_name;
					sex = prev_sex;
					d3.select('#gender').attr('value', sex);
					setMaleFemaleSwitch();
					handleAutocomplete();
					updateMap();
				}
			});

		//handle when user doesn't select autocomplete option, enters own name and presses enter.
		d3.select("#name-input").on("keydown", function() {
			if(d3.event.keyCode == 13) {

				var entered_name = '';
				var selected_sex = '';

				if(this.value == '') {
					this.value = popular_name;
					this.blur();
					return;
				}
				else {
					entered_name = this.value.replace(/\s/g,'');
					selected_sex = d3.select('#gender').attr('value');
				}

				if(entered_name != popular_name || selected_sex != sex) {
					popular_name = entered_name;
					sex = selected_sex;
					autocomplete.close();
					init();
				}

			}
		});

		if(mode == 'edit') {
			d3.select("#name-input").attr('class','name-input-edit');
			document.getElementById('name-input').focus();
			mode = 'display';
		}

	}

	function nameSelected(evt) {

		var selected_name = evt.text.value;
		sex = "F"
		if(selected_name.indexOf('(Boy)') > 0) {
			sex = "M";
		}

		selected_name = selected_name.replace('&nbsp;(Boy)','');
		selected_name = selected_name.replace('&nbsp;(Girl)','');
		popular_name = selected_name;
		document.querySelector('#name-input').value = popular_name;

		d3.selectAll("input[name='switch_mf']").each(function(){
			if(d3.select(this).node().value == sex)
				d3.select(this).node().checked = true;
		});

		init();

	}

	function setMaleFemaleSwitch() {

		var gender = d3.select('#gender').attr('value');

		if(gender == 'M') {
			var button_boy = d3.select('#button-boy');
			button_boy.classed('is-primary', true);

			var button_girl = d3.select('#button-girl');
			button_girl.classed('is-primary', false);

		}

		if(gender == 'F') {
			var button_girl = d3.select('#button-girl');
			button_girl.classed('is-primary', true);

			var button_boy = d3.select('#button-boy');
			button_boy.classed('is-primary', false);

		}

	}

	function populateOccurencesFrom(name_data) {

		//append date to the name_data as the last day of occurrence yr
		occurrences = name_data;

		//add actual date field to occurrences for easier processing later
		for (occurrence in occurrences) {
			var dt = "12/31/" + occurrences[occurrence].yr;
			occurrences[occurrence].date = new Date(dt);
		}

		for (occurrence in occurrences) {
			var normalized = ((occurrences[occurrence].oc / occurrences[occurrence].tot) * 100).toFixed(2);
			occurrences[occurrence].normalized = normalized;
		}

	}

	function joinDataToGeom(states, name_data) {

		states.objects.states.geometries.forEach(function(d) {
			var layer_stusps = d.properties.stusps;
			d.properties.occurrences = [];
			var i = 0;
			for (var occurrence in occurrences) {
				if(layer_stusps == occurrences[occurrence].st) {
					d.properties.occurrences[i] = occurrences[occurrence];
					i++;
				}
			}
		});

	}

	function populateMaxMinYear() {

		var first_date = new Date(occurrences[0].date);
		var last_date = new Date(occurrences[occurrences.length-1].date);

		min_year = first_date.getFullYear();
		max_year = last_date.getFullYear();
		this_year = min_year;

		d3.select("#slider-min-label").html(min_year);
		d3.select("#slider-max-label").html(max_year);

	}

	function populateBreaks(number_of_classes, states) {

		var occurrences_acc = [];

		states.objects.states.geometries.forEach(function(d) {
			for (occurrence in d.properties.occurrences) {
				occurrences_acc.push(d.properties.occurrences[occurrence].normalized);
			}
		});

		if(occurrences_acc.length <= number_of_classes) {
			number_of_classes = occurrences_acc.length;
		}

		var clusters = ss.ckmeans(occurrences_acc, number_of_classes);
		var brks = clusters.map(function(cluster) {
			return [cluster[0], cluster.pop()];
		});

		breaks = multiDimensionalUnique(brks);

	}

	function addMapContainer() {

		d3.select('#states_svg_map').remove();

		var states_svg = d3.select("#map-wrapper")
			.append("svg")
				.attr('id','states_svg_map')
				.attr("viewBox", "0 0 800 450");

	}

	function addBackgroundToMapContainer() {

		//this is to catch when the mouse goes off the map, turn tooltip off. hack.
		var states_svg = d3.select('#states_svg_map');

		d3.select('#map-background').remove();
		states_svg.append('rect')
			.attr('id', 'map-background')
			.style('fill', novalue_color)
			.style('width', '100%')
			.style('height', '100%')
			.attr('transform', 'translate (0, 1)')
			.on('mouseover',function(d) {
				tooltip.style('opacity', 0);//TODO, figure a better tooltip
			});

	}

	function addStatesToMapContainer(statestopo) {

		var states_svg = d3.select('#states_svg_map');

		d3.select('#states').remove();

		states_svg.append("g")
			.attr('id','states')
			.attr('transform','translate(-130, -70) scale(1.15)')
			.selectAll("path")
			.data( topojson.feature(statestopo, statestopo.objects.states).features )
				.enter()
				.append('path')
				.attr('d',geoPath)
				.attr('class', 'state')
				.style('stroke', default_gray)
				.on('mouseover', function(d) {
					var tooltip_msg = getTooltipMessage(d);
					tooltip.transition()
						.style("opacity", .9);
					tooltip.html(tooltip_msg)
						.style("left", (d3.event.pageX + 15) + "px")
						.style("top", (d3.event.pageY - 28) + "px");
					d3.select(this).style("stroke", highlight_color);//outline the state with highlight_color
					d3.select(this).style("stroke-width", "2");
					//https://stackoverflow.com/questions/17917072/choropleth-maps-changing-stroke-color-in-mouseover-shows-overlapping-boundari
					this.parentNode.appendChild(this);//append it to parent to make it move to top, otherwise outline is covered by bordering state lines
				})
				.on('mouseout', function(d) {
					d3.select(this).style("stroke", default_gray);//return st outline to gray
					d3.select(this).style("stroke-width", "1");
					tooltip.style("opacity", 0);
				});

	}

	function setMostPopularYear() {

		var year_accumulations = [];
		var last_yr = occurrences[0].yr;
		var year_accum = 0;

		for(var oc in occurrences) {
			// console.log(occurrences[oc].yr);
			if(occurrences[oc].yr == last_yr) {
				year_accum += occurrences[oc].oc;
			}
			else {
				year_accumulations.push([last_yr, year_accum]);
				year_accum = occurrences[oc].oc;
				last_yr = occurrences[oc].yr;
			}
		}
		year_accumulations.push([last_yr, year_accum]);

		if(year_accumulations.length == 0)
			return;

		var most_pop_year = year_accumulations[0][0];
		var most_pop_acc = year_accumulations[0][1];

		for(var acc in year_accumulations) {
			if(year_accumulations[acc][1] > most_pop_acc) {

				// console.log(most_pop_year);

				most_pop_acc = year_accumulations[acc][1];
				most_pop_year = year_accumulations[acc][0];
			}
		}

		most_popular_year = most_pop_year;

	}

	function addYearFlameTooltip() {

		var year_wrapper = d3.select('#year-wrapper');

		year_wrapper.html(this_year);

		var year_flame_wrapper = d3.select('#year-flame-wrapper')
			.on('mouseover', function() {
				if(this_year == most_popular_year) showFlameTooltip();
			})
			.on('mouseoout', function() {
				if(this_year = most_popular_year) tooltip.style("opacity", 0);//TODO, figure a better tooltip
			});
	}

	function showFlameTooltip() {
		var tooltip_msg = '#cnt# #nameplural# were born in #yr#, more than any other year on record.';
		tooltip_msg = tooltip_msg.replace('#cnt#', total_occurrences_for_year.toLocaleString());
		tooltip_msg = tooltip_msg.replace('#yr#', this_year);
		tooltip_msg = tooltip_msg.replace('#nameplural#', getPluralized(popular_name));
		tooltip_msg = tooltip_msg.replace('#popular_name#', popular_name);
		tooltip.transition()
			.style("opacity", .9);
		tooltip.html(tooltip_msg)
			.style("left", (d3.event.pageX + 15) + "px")
			.style("top", (d3.event.pageY - 28) + "px");
	}

	function addBars() {

		//get array of years, with each years total occurrences, regardless of state
		var year_accumulations = getObjectArrayOfYearAccumulations(occurrences);

		// set the dimensions and margins of the graph
		var margin = {top: 0, right: 0, bottom: 0, left: 0},
		    width = 205 - margin.left - margin.right,
		    height = 75 - margin.top - margin.bottom;

		// set the ranges
		var x = d3.scaleBand()
		  .range([0, width])
		  .padding(0.01);
		var y = d3.scaleLinear()
		  .range([height, 0]);

		d3.select('#bar-chart-svg').remove();

		var bar_chart_wrapper = d3.select('#bar-chart-wrapper');

		// return;

		d3.select('#bar-chart-wrapper')
			.append('svg')
				.attr('viewBox', '0 0 205 75')
				.attr('transform', 'translate (0, 0) scale(.98 1)')
				.attr('id','bar-chart-svg');

		var bar_chart_svg = d3.select('#bar-chart-svg');

		bar_chart_svg.append('g')
		  .attr('id', 'bar-chart-root');

		var bar_chart_root = d3.select('#bar-chart-root');

		bar_chart_root.append("g")
		  .attr('id', 'bar-chart');

		// Scale the range of the data in the domains
		x.domain(year_accumulations.map(function(d) { return d.yr; }));
		y.domain([0, d3.max(year_accumulations, function(d) { return d.year_accum; })]);

		var bar_chart_group = d3.select('#bar-chart-root');

		// append the rectangles for the bar chart
		bar_chart_group.selectAll(".bar")
		  .data(year_accumulations)
		    .enter().append("rect")
		      .style('fill', bar_fill_color)
		      .attr('class', 'bar')
		      .attr('id', function(d) { return 'bar-' + d.yr; })
		      .attr('x', function(d) { return x(d.yr); })
		      .attr('width', x.bandwidth())
		      .attr('y', function(d) { return y(d.year_accum); })
		      .attr('height', function(d) { return height - y(d.year_accum); });

		// bar_chart_svg.append('rect')
		// 	.attr('width', width)
		// 	.attr('height', height)
		// 	.style('stroke', '#000000')
		// 	.style('stroke-width', '.03pt')
		// 	.style('fill', 'none')
		// 	.attr('id', 'bars-outline');
	}

	function highlightBarForThisYear() {

		d3.selectAll('.bar').each(function(d) {
		  var bar = d3.select(this);
		  var bar_id = bar._groups[0][0].id;
		  if ( bar_id == 'bar-' + this_year ) { bar.style('fill', highlight_color); }
		  else { bar.style('fill', bar_fill_color); }
		});

	}

	function addCells() {

		d3.select('#cells-svg').remove();

		d3.select('#cells-wrapper')
			.append('svg')
				.attr("viewBox", "0 0 206 26")
				// .attr("transform", "translate (0, -28) scale(.86)")
				.attr("transform", "translate (0, 0) scale(.98 1)")
				.attr('id','cells-svg');

		var cells_svg = d3.select('#cells-svg');

		cells_svg.append('g')
		  .attr('id', 'cells-root');

		var cells_root = d3.select('#cells-root');

		var i = 0;
		for(var br in breaks) {
		  cells_root.append("g")
		    .attr("id", "cell" + i)
		    .attr("transform", "translate(" + i * 41.5 + ",0)")
		  i++;
		}

		i = 0;
		for(var br in breaks) {
		  var cell = d3.select('#cell' + i);

		  cell.append('rect')
		    .attr('class', 'legend-swatch')
		    .attr('height', 15)
		    .attr('width', 39.5)
		    .attr('fill', getColor(breaks[br][1], breaks));

		  cell.append('text')
		    .text(breaks[br][1] + '%')
		    .attr('class', 'swatch-label')
		    .attr('transform', 'translate(39.5, 24)');

		  i++;
		}

	}

	function addSlider() {

		d3.select('#slider-year').remove();

		d3.select('#slider-wrapper')
			.append('input')
				.attr('type', 'range')
				.attr('id','slider-year')
				.attr('min', min_year)
				.attr('max', max_year);

		d3.select('#min-year-label').html(min_year);
		d3.select('#max-year-label').html(max_year);
		d3.select('#slider-year').attr('value', this_year);

		d3.select('#slider-year').on('input', function() {
  		this_year = this.value;
			d3.select('#year-wrapper').html(this_year);
			highlightBarForThisYear();
			updateMap();
		});

	}

	function getObjectArrayOfYearAccumulations(name_data) {

		var year_accumulations = [];
		var first_yr = name_data[0].yr;
		var last_yr = name_data[name_data.length - 1].yr;

		var last_yr = name_data[0].yr;
		var year_accum = 0;

		for(var oc in name_data) {
			if(name_data[oc].yr == last_yr) {
				year_accum += name_data[oc].oc;
				last_yr = name_data[oc].yr;
			}
			else {
				year_accum = name_data[oc].oc;
				last_yr = name_data[oc].yr;
			}

			var year = {};
			year.yr = last_yr;
			year.year_accum = year_accum;
			year_accumulations.push(year);

		}

		//add back any 0 occurrence yrs
		var missing_years = [];
		for (i = first_yr; i <= last_yr; i++) {
			var found = false;
			for(var oc in name_data) {
				if(i == name_data[oc].yr) {
					found = true;
				}
			}
			if(found == false)
				missing_years.push(i);
		}

		if(missing_years && missing_years.length > 0) {
			for(var yr in missing_years) {
				var year = {};
				year.yr = missing_years[yr];
				year.year_accum = 0;
				year_accumulations.push(year);
			}
		}

		year_accumulations.sort(function(a, b) {
			return a.yr - b.yr;
		})

		return year_accumulations;

	}

	function getColor(d, breaks) {

		//console.log(d);

		var br = breaks[breaks.length - 1];

		while(breaks.length < 3) {
			breaks.push(br);
		}

		var colors = d3.entries(eval(color_key));
		var color_scale = colors[breaks.length - 1];
		var returncolor = novalue_color;
		d = parseFloat(d);

		if(d == 0)
			returncolor = novalue_color;

		if (breaks[0] && d <= breaks[0][1]) {
			returncolor = color_scale.value[0];
		} else if (breaks[1] && d <= breaks[1][1]) {
			returncolor = color_scale.value[1];
		} else if (breaks[2] && d <= breaks[2][1]) {
			returncolor = color_scale.value[2];
		} else if (breaks[3] && d <= breaks[3][1]) {
			returncolor = color_scale.value[3];
		} else if (breaks[4] && d <= breaks[4][1]) {
			returncolor = color_scale.value[4];
		} else if (breaks[5] && d <= breaks[5][1]) {
			returncolor = color_scale.value[5];
		} else if (breaks[6] && d <= breaks[6][1]) {
			returncolor = color_scale.value[6];
		} else if (breaks[7] && d <= breaks[7][1]) {
			returncolor = color_scale.value[7];
		} else if (breaks[8] && d <= breaks[8][1]) {
			returncolor = color_scale.value[8];
		} else if (breaks[9] && d <= breaks[9][1]) {
			returncolor = color_scale.value[9];
		}

		return returncolor;

	}

	function getTooltipMessage(d) {

		var tooltip_msg = "No " + getPluralized(popular_name) + " were born in " + abbrRegion(d.properties.stusps, 'name')  + " in " + this_year + ".";

		for(var oc in occurrences) {
				if(occurrences[oc].yr == this_year && occurrences[oc].st == d.properties.stusps) {
					tooltip_msg = 'In #state# in #year#, there were #total_for_state# #genderplural# popular name births, #total_for_name# named #the_name# [#pct#].';
					tooltip_msg = tooltip_msg.replace('#year#', this_year);
					tooltip_msg = tooltip_msg.replace('#state#', abbrRegion(occurrences[oc].st, 'name'));
					tooltip_msg = tooltip_msg.replace('#total_for_state#', occurrences[oc].tot.toLocaleString());
					tooltip_msg = tooltip_msg.replace('#genderplural#', getDisplayGenderMF().toLowerCase());
					tooltip_msg = tooltip_msg.replace('#total_for_name#', occurrences[oc].oc.toLocaleString());
					tooltip_msg = tooltip_msg.replace('#the_name#', popular_name);
					var pct = occurrences[oc].normalized;
					tooltip_msg = tooltip_msg.replace('#pct#', pct + '%');
				}
		}

		return tooltip_msg;
	}

	function getDisplayGender() {
		var display_gender = "Boy";
		if(sex == 'F') { display_gender = "Girl"; }
		return display_gender;
	}

	function getDisplayGenderMF() {
		var display_gender = "Male";
		if(sex == 'F') { display_gender = "Female"; }
		return display_gender;
	}

	function setBarFillColor() {
		//set the bar_fill_color to the midrange color
		var shift = 3;
		if (breaks.length < 4) { shift = 1; }
		bar_fill_color = getColor(breaks[breaks.length - shift][1], breaks);
	}

	function getPluralized(name) {

		//https://english.stackexchange.com/questions/39150/pluralization-of-names
		//If the name ends in s, sh, ch, x or z, add es.

		var plural_append = "s";
		if(popular_name.endsWith('s')) {
			plural_append = "es";
		}
		else if (popular_name.endsWith('sh')) {
			plural_append = "es";
		}
		else if (popular_name.endsWith('ch')) {
			plural_append = "es";
		}
		else if (popular_name.endsWith('x')) {
			plural_append = "es";
		}
		else if (popular_name.endsWith('z')) {
			plural_append = "es";
		}

		return name + plural_append;
	}

	function getNameFromQS() {
		var name_query = gup('name', document.location.search);
		if(name_query != null)
			return name_query;
		else {
			return default_popular_name;
		}
	}

	function getSexFromQS() {
		var sex_query = gup('sex', document.location.search);
		if(sex_query != null) {
			return sex_query;
		}
		else {
			return sex;
		}
	}

	function getYearFromQS() {
		var yr_query = gup('yr', document.location.search);
		if(yr_query != null) {
			return yr_query;
		}
		else {
			return most_popular_year;
		}
	}

	function getColorKeyFromQS() {
		var ck_query = gup('ck', document.location.search);
		if(ck_query != null) {
			return ck_query;
		}
		else {
			return color_key;
		}
	}

	function getHighlightColorFromQS() {
		var hl_query = gup('hl', document.location.search);
		if(hl_query != null) {
			return hl_query;
		}
		else {
			return highlight_color;
		}
	}

	function handleBoyGirlClick() {

		d3.selectAll('.button').on('click', function(data, index) {

			var gen = 'M';
			if(index == 1) { gen = 'F'}

			tooltip.style("opacity", 0);

			prev_sex = sex;

			sex = gen;

			d3.select('#gender').attr('value', sex);

			setMaleFemaleSwitch();

			mode = 'edit';

			var states_svg = d3.select('#states_svg_map');

			states_svg.selectAll('.state')
				.style('fill', function(d) {
					return novalue_color;
				});

			handleAutocomplete();

	  });

	}

	</script>

	<script type="text/javascript">

	document.addEventListener('DOMContentLoaded', function () {

		// Get all "navbar-burger" elements
		var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

		// Check if there are any navbar burgers
		if ($navbarBurgers.length > 0) {
			// Add a click event on each of them
			$navbarBurgers.forEach(function ($el) {
				$el.addEventListener('click', function () {
					// Get the target from the "data-target" attribute
					var target = $el.dataset.target;
					var $target = document.getElementById(target);
					// Toggle the class on both the "navbar-burger" and the "navbar-menu"
					$el.classList.toggle('is-active');
					$target.classList.toggle('is-active');
					$target.classList.toggle('navbar-menu');
					$target.childNodes[1].classList.toggle('navbar-end');
				});
			});
		}
	});

	</script>

</body>
</html>
